<html>
    <head>
        <script src='/_ah/channel/jsapi'></script>
    </head>
    <body>
        <script type='text/javascript'>
        	var state = {
                current_user: '{{ current_user }}'
            };
        	
        	updateSource = function()
        	{
        		//Will set the display stuff.
            }
        
        	getPosition = function()
        	{
        		var the_source = document.getElementById('the_source');
        		var offset = the_source.offset();
        	    alert(e.clientX - offset.left);
        	    alert(e.clientY - offset.top);
        	}
        	
        	sendMessage = function(path, opt_param) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', path, true);
                xhr.send();
            };
        
            onOpened = function()
            {
                sendMessage('/opened');
            };
              
            onMessage = function(m)
            {
                newState = JSON.parse(m.data);
                state.current_user = newState.current_user || state.current_user;
                state.x_position = newState.x_position || state.x_position;
                state.y_position = newState.y_position || state.y_position;
                updateSource();
            }
        
            openChannel = function()
            {
                var token = '{{ token }}';
                var channel = new goog.appengine.Channel(token);
                var handler = {
                    'onopen': onOpened,
                    'onmessage': onMessage,
                    'onerror': function() {},
                    'onclose': function() {}
                };
                var socket = channel.open(handler);
                socket.onopen = onOpened;
                socket.onmessage = onMessage;
            }
        
            initialize = function()
            {
                openChannel();
                var the_source = document.getElementById('the_source');
                the_source.onclick = new Function('getPosition()');
                onMessage({data: '{{ initial_message }}'});
            }  
        
            setTimeout(initialize, 100);
        </script>
        <img id = 'the_source' src = '/images/sidewalk.jpg' />
    </body>
</html>