<html>
  <head>
  	  <title>Crowd Navigation</title>
      <script src='/_ah/channel/jsapi'></script>
  </head>
  <body>
    <script src="/js/jquery-2.0.3.min.js" type="text/javascript" ></script>
    <script type="text/javascript" >
      var state = {
        source_key: '{{ source_key }}',
        current_user_id: '{{ current_user_id }}',
      };
      var crowd = {};

      updateSource = function() {
    	  $("#direction").html(state.direction);
    	  var output = ""
    	  for (var key in crowd) {
    	      if(crowd.hasOwnProperty(key)) {
    	    	  output.concat(key, " ", crowd[key], "\n");
    	      }
    	  }
    	  $("#all_directions").html(output);
      };

      sendMessage = function(path, opt_param) {
        path += '?g=' + state.source_key;
        if (opt_param) {
          path += '&' + opt_param;
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', path, true);
        xhr.send();
      };
      
      onOpened = function() {
        sendMessage('/opened');
      };
      
      changeDirection = function(e) {
          e = e || window.event;

          if (e.keyCode == '37') {
              //Left arrow.
              d = "Left";
          }
          else if (e.keyCode == '38') {
              //Up arrow.
              d = "Forward";
          }
          else if (e.keyCode == '39') {
              //Right arrow.
              d = "Right";
          }
          else if (e.keyCode == '40') {
              //Down arrow.
              d = "Stop";
          }
          state.direction = d;
    	  updateSource();
    	  sendMessage('/direction', 'd=' + d);
      };
      
      onMessage = function(m) {
        newState = JSON.parse(m.data);
        user = newState.user;
        direction = newState.direction;
        crowd[user] = direction;
        updateSource();
      };
      
      openChannel = function() {
        var token = '{{ token }}';
        var channel = new goog.appengine.Channel(token);
        var handler = {
          'onopen': onOpened,
          'onmessage': onMessage,
          'onerror': function() {},
          'onclose': function() {}
        };
        var socket = channel.open(handler);
        socket.onopen = onOpened;
        socket.onmessage = onMessage;
      };
      
      initialize = function() {
        openChannel();
        document.onkeydown = changeDirection;
        onMessage({data: '{{ initial_message }}'});
      };

      setTimeout(initialize, 100);

    </script>
    <div>
		<object width="600" height="409"> <param name="movie" value="http://fpdownload.adobe.com/strobe/FlashMediaPlayback.swf"></param><param name="flashvars" value="src=rtmp%3A%2F%2F67.244.90.144%3A1935%2Flive%2FmyStream&poster=http%3A%2F%2Fs9.postimg.org%2Fbm6fpc0sv%2Fposter_crowd_navigation.jpg&streamType=live"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://fpdownload.adobe.com/strobe/FlashMediaPlayback.swf" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="600" height="409" flashvars="src=rtmp%3A%2F%2F67.244.90.144%3A1935%2Flive%2FmyStream&poster=http%3A%2F%2Fs9.postimg.org%2Fbm6fpc0sv%2Fposter_crowd_navigation.jpg&streamType=live"></embed></object>
        <iframe width="420" height="360" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?f=q&amp;source=s_q&amp;hl=en&amp;geocode=&amp;q=&amp;aq=&amp;sll=40.522151,-73.443604&amp;sspn=5.761748,13.392334&amp;ie=UTF8&amp;ll=40.819753,-73.949726&amp;spn=0.011205,0.026157&amp;t=m&amp;z=16&amp;output=embed"></iframe>
    </div>
    <div style="font-size: 20pt;">
    	Direction: <span id="direction">Nothing</span>
    </div>
    <div>
    	All Directions: <span id="all_directions">Nothing</span>
    </div>
    <div>
    	Source Link: <span id="source_key">http://crowd-navigation.appspot.com/?g={{ source_key }}</span>
    </div>
  </body>
</html>
